{{/*
Minimal WhatsApp Icon-only FAB (v1.3, official-like)
- 圆形悬浮按钮，绿色底（CSS），白色 glyph（SVG path）
- 占位符：{site} {title} {url}
*/}}


{{- $cfg := .Site.Params.whatsapp -}}
{{- if and $cfg ($cfg.enabled | default true) -}}
{{- $phone := $cfg.phone | default "" -}}
{{- if ne $phone "" -}}
{{- $siteTitle := .Site.Title | default "" -}}
{{- $pageTitle := .Title | default $siteTitle -}}
{{- $pageURL := .Permalink | default (print .Site.BaseURL) -}}
{{- $tpl := $cfg.messageTpl -}}
{{- $msg := $tpl | replace "{site}" $siteTitle | replace "{title}" $pageTitle | replace "{url}" $pageURL -}}
{{- $label := $cfg.label | default "Chat on WhatsApp" -}}
{{- $href := printf "https://wa.me/%s?text=%s" $phone (urlquery $msg) -}}


<div class="wa-fab" data-wa data-wa-href="{{ $href }}" data-wa-msg="{{ $msg }}">
<a class="wa-fab__btn" href="{{ $href }}" target="_blank" rel="noopener" aria-label="{{ $label }}" title="{{ $label }}">
<svg class="wa-fab__icon" viewBox="0 0 24 24" width="26" height="26" aria-hidden="true" focusable="false">
<!-- 官方风格：白色 WhatsApp glyph，按钮绿色由 CSS 提供 -->
<path fill="#FFFFFF" d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.1-.472-.149-.67.149-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.074-.297-.149-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.173.198-.298.298-.497.099-.198.049-.372-.025-.521-.074-.148-.669-1.611-.916-2.207-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372s-1.04 1.016-1.04 2.479 1.065 2.876 1.213 3.074c.149.198 2.095 3.2 5.076 4.487.709.306 1.262.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.413-.074-.123-.272-.198-.57-.347zM12.005 2.003c-5.522 0-10.001 4.477-10.001 9.997 0 1.762.467 3.468 1.354 4.966L2 22l5.173-1.355c1.45.797 3.088 1.215 4.832 1.215 5.522 0 10.001-4.477 10.001-9.997S17.527 2.003 12.005 2.003z"/>
</svg>
</a>
</div>


<style>
.wa-fab { position: fixed; right: 18px; bottom: 18px; z-index: 9999; }
.wa-fab__btn { width: 64px; height: 64px; display: inline-flex; align-items: center; justify-content: center; background: #25D366; color: #fff; text-decoration: none; border-radius: 50%; box-shadow: 0 8px 20px rgba(0,0,0,.15); outline: none; transition: transform .15s ease, background .15s ease, box-shadow .15s ease; }
.wa-fab__btn:hover { background: #1faa56; transform: translateY(-1px); box-shadow: 0 10px 22px rgba(0,0,0,.18); }
.wa-fab__btn:active { transform: translateY(0); box-shadow: 0 6px 16px rgba(0,0,0,.14); }
.wa-fab__btn:focus-visible { box-shadow: 0 0 0 3px rgba(37,211,102,.35), 0 8px 20px rgba(0,0,0,.15); }
.wa-fab__icon { display:block; width:36px; height:36px; }
@supports (padding: max(0px)) { .wa-fab { right: max(12px, env(safe-area-inset-right)); bottom: max(12px, env(safe-area-inset-bottom)); } }
@media (max-width: 420px){ .wa-fab__btn { width: 52px; height: 52px; } .wa-fab__icon { width:24px; height:24px; } }
</style>


<script>
(function(){
var root = document.querySelector('[data-wa]');
if(!root) return;
var a = root.querySelector('.wa-fab__btn');
var baseHref = root.getAttribute('data-wa-href');
var baseMsg = root.getAttribute('data-wa-msg') || '';
function buildText(base){
var parts = [String(base||'').trim()];
try{
if(document.referrer) parts.push('Referrer: '+document.referrer);
var loc = new URL(window.location.href);
var keys = ['utm_source','utm_medium','utm_campaign','utm_term','utm_content'];
var hasUTM = keys.some(function(k){ return loc.searchParams.get(k); });
if(hasUTM) parts.push('UTM: '+loc.search);
}catch(e){}
return parts.join(' | ');
}
a.addEventListener('click', function(){
try{
var url = new URL(baseHref);
url.searchParams.set('text', buildText(baseMsg));
a.setAttribute('href', url.toString());
}catch(e){}
try{ window.dataLayer = window.dataLayer || []; window.dataLayer.push({event:'WhatsAppOpen', placement:'fab'}); }catch(e){}
try{ if(window.gtag) window.gtag('event','WhatsAppOpen',{placement:'fab'}); }catch(e){}
try{ if(window.fbq) window.fbq('trackCustom','WhatsAppOpen',{placement:'fab'}); }catch(e){}
});
})();
</script>
{{- end -}}
{{- end -}}